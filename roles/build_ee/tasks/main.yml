---

- name: Ensure old EE is removed
  command:
    cmd: "podman rmi aaphub.shadowman.dev/full/ansibleee"
  changed_when: true

- name: Build new EE
  command:
    cmd: "ansible-builder build -t aaphub.shadowman.dev/full/ansibleee"
    chdir: /home/adworjan/ansible/execution/
  changed_when: true

- name: Remove <none> images after build
  command:
    cmd: "podman rmi $(podman images -f 'dangling=true')"
  register: result
  changed_when: '"repository name must be" in result.stderr'

- name: push new EE to PAH
  command:
    cmd: "podman push --creds={{pah_user}}:{{pah_pass}} aaphub.shadowman.dev/full/ansibleee"
  changed_when: true